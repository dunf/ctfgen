heat_template_version: 2015-10-15
description: Management template for attack-defense scenarios

parameters:
  public_net: {type: string, default: ntnu-internal}
  puppet-master_server_name: {type: string, default: puppet-master}
  puppet-master_image: {type: string, default: Ubuntu Server 18.04 LTS (Bionic Beaver) amd64}
  puppet-master_flavor: {type: string, default: m1.medium}
  key_name: {type: string, default: testkey }

  management-lan_net_cidr: {type: string, default: 192.168.200.0/24}
  management-lan_net_gateway: {type: string, default: 192.168.200.1}
  management-lan_net_pool_start: {type: string, default: 192.168.200.50}
  management-lan_net_pool_end: {type: string, default: 192.168.200.200}

resources:
  management-net:
    type: OS::Neutron::Net
    properties: {name: Management Net }

  puppet-master:
    type: OS::Nova::Server
    properties:
      name: {get_param: puppet-master_server_name}
      image: {get_param: puppet-master_image}
      flavor: {get_param: puppet-master_flavor}
      key_name: {get_param: key_name}
      networks:
      - port: {get_resource: puppet-master_port0}
      user_data_format: RAW
      user_data:
        str_replace:
          template: { get_file: bootstrap/puppet-master.sh }
          params:
            __teststring__: "This script should eventually do something useful..."

  puppet-master_port0:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: management-net}
      security_groups:
      - {get_resource: puppet-master_security_group_management-lan}
      fixed_ips:
      - subnet_id: {get_resource: management-lan}
      
  puppet-master_security_group_management-lan:
    type: OS::Neutron::SecurityGroup
    properties:
      rules:
      - {remote_ip_prefix: 0.0.0.0/0, protocol: icmp}
      - {remote_ip_prefix: 0.0.0.0/0, protocol: tcp, port_range_min: 22, port_range_max: 22}
      - {remote_ip_prefix: 0.0.0.0/0, protocol: tcp, port_range_min: 80, port_range_max: 80}
      - {remote_ip_prefix: 0.0.0.0/0, protocol: udp, port_range_min: 53, port_range_max: 53}
      - {remote_ip_prefix: 0.0.0.0/0, protocol: udp, port_range_min: 8140, port_range_max: 8140}

  Management-router:
    type: OS::Neutron::Router
    properties:
      name: Management Router
      external_gateway_info:
        network: {get_param: public_net}

  Management-router_interface_management-lan:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: {get_resource: Management-router}
      subnet_id: {get_resource: management-lan}
      
  management-lan:
    type: OS::Neutron::Subnet
    properties:
      name: management-lan
      network_id: {get_resource: management-net}
      cidr: {get_param: management-lan_net_cidr}
      gateway_ip: {get_param: management-lan_net_gateway}
      allocation_pools:
      - start: {get_param: management-lan_net_pool_start}
        end: {get_param: management-lan_net_pool_end}

  puppet-master_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: { get_param: public_net }
      port_id: { get_resource: puppet-master_port0 }

outputs:
  puppet_master_ip:
    description: IP address of puppet master 
    value: { get_attr: [ puppet-master, first_address ]}